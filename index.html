<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0c" />
  <title>Тренировки</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg0:#0b0b0c;
      --bg1:#111114;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --txt:#f3f3f4;
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);

      --ok:#34c759;
      --warn:#ff9f0a;
      --bad:#ff3b30;

      --r: 16px;
      --tap: 52px;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f3f4f7;
        --bg1:#ffffff;
        --card: rgba(255,255,255,.75);
        --card2: rgba(255,255,255,.55);
        --border: rgba(0,0,0,.08);
        --txt:#111114;
        --muted: rgba(0,0,0,.62);
        --muted2: rgba(0,0,0,.45);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(52,199,89,.16), transparent 55%),
        radial-gradient(900px 700px at 85% 25%, rgba(0,122,255,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,159,10,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 28px}
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding:6px 2px 14px;
    }
    h1{margin:0; font-size:22px; font-weight:800; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35}

    .topActions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      height:40px; padding:0 12px; border-radius:12px;
      border:1px solid var(--border);
      background: var(--card);
      color:var(--txt); font-weight:700; cursor:pointer;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ok{border-color: rgba(52,199,89,.35)}
    .btn.bad{border-color: rgba(255,59,48,.35); color: var(--bad)}
    .btn.mini{height:34px; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px}

    .sel{
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--card);
      color:var(--txt);
      font-weight:800;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      appearance:none;
      -webkit-appearance:none;
    }

    .grid{
      display:grid; grid-template-columns: 1fr; gap:12px;
    }
    @media (min-width:900px){
      .grid{grid-template-columns: 1.25fr .75fr}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding:14px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 12px 40px rgba(0,0,0,.18);
    }

    .rowBetween{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .title2{font-size:14px; font-weight:900; margin:0}
    .mini{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}

    .seg{
      display:inline-flex; gap:0; border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    @media (prefers-color-scheme: light){
      .seg{ background: rgba(255,255,255,.55); }
    }
    .seg button{
      height:40px; padding:0 14px;
      border:0; background:transparent; color:var(--txt);
      font-weight:900; cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
    }
    @media (prefers-color-scheme: light){
      .seg button.active{ background: rgba(0,0,0,.06); }
    }

    details.week{
      border:1px solid var(--border);
      border-radius: 14px;
      background: var(--card2);
      padding:10px;
      margin-top:10px;
    }
    details.week summary{
      list-style:none;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:6px 6px;
      font-weight:900;
    }
    details.week summary::-webkit-details-marker{display:none}
    .weekMeta{font-weight:800; color:var(--muted); font-size:12px}

    .session{
      border:1px solid var(--border);
      border-radius:14px;
      background: var(--card);
      padding:12px;
      margin-top:10px;
    }

    .badge{
      font-size:12px; padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.done{border-color: rgba(52,199,89,.35); color: var(--ok); background: rgba(52,199,89,.10);}

    .sessionHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .sid{font-weight:1000; letter-spacing:.2px}
    .stats{margin-top:3px; font-size:12px; color:var(--muted)}
    .sessionBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .sets{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .setRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.08);
      min-height: var(--tap);
    }
    @media (prefers-color-scheme: light){
      .setRow{ background: rgba(255,255,255,.55); }
    }
    .setLeft{display:flex; flex-direction:column; gap:2px}
    .mainLine{font-weight:950}
    .minorLine{font-size:12px; color:var(--muted)}
    .checks{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .chk{
      width:36px; height:36px; border-radius:10px;
      border:1px solid var(--border);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      font-weight:1000;
      background: rgba(255,255,255,.02);
    }
    .chk.on{
      border-color: rgba(52,199,89,.45);
      background: rgba(52,199,89,.14);
      color: var(--ok);
    }

    textarea{
      width:100%; min-height:140px; resize:vertical;
      background: var(--card2); color:var(--txt);
      border:1px solid var(--border); border-radius:14px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius:14px;
      padding:10px;
    }
    .label{font-size:11px; color:var(--muted); font-weight:900; margin-bottom:6px}
    .inp{
      width:100%;
      height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--txt);
      padding:0 10px;
      font-weight:900;
      font-size:13px;
    }
    @media (prefers-color-scheme: light){
      .inp{ background: rgba(0,0,0,.03); }
    }
    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.25}

    /* Узкие экраны (iPhone) */
    @media (max-width: 430px){
      .setRow{
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .checks{
        justify-content: flex-start;
        gap: 6px;
      }
      .chk{
        width: 30px;
        height: 30px;
        border-radius: 9px;
        font-size: 12px;
      }
      .sessionHead{
        flex-direction: column;
        align-items: stretch;
      }
      .sessionBtns{
        width: 100%;
        justify-content: flex-start;
      }
      .btn.mini{
        height: 32px;
        border-radius: 10px;
        padding: 0 9px;
        font-size: 11px;
      }
      .seg button{
        height: 36px;
        padding: 0 10px;
        font-size: 13px;
      }
      .sel{
        height: 36px;
        font-size: 13px;
      }
      .formGrid{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Тренировочный план</h1>
      <div class="sub" id="subtitle">
        Отметки сохраняются на устройстве (по месяцам). Логика: <b>квадратик = подход</b>.<br>
        Структура: <b>День 1</b> (Жим+Руки+Тяга), <b>День 2</b> (Жим+Ноги), <b>День 3</b> (Жим+Руки+Плечи).
      </div>
    </div>
    <div class="topActions">
      <select class="sel" id="monthSel" title="Месяц"></select>
      <button class="btn ok" id="btnNext">Следующая</button>
      <button class="btn bad" id="btnResetExercise">Сброс упражнения</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="rowBetween">
        <div>
          <div class="mini">Группа</div>
          <div class="seg" id="groupSeg"></div>
        </div>
        <div>
          <div class="mini">Упражнение</div>
          <div class="seg" id="exerciseSeg"></div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="rowBetween">
        <div>
          <div class="title2" id="exTitle">—</div>
          <div class="mini" id="exMeta">—</div>
        </div>
        <div class="mini" id="exProgress">—</div>
      </div>

      <div id="weeks"></div>

      <div class="mini" style="margin-top:10px">
        Подсказка: в каждой строке веса можно нажать «✓ все», чтобы отметить все подходы этим весом.
      </div>
    </div>

    <div class="card">
      <div class="rowBetween">
        <div>
          <div class="title2">Максимумы на месяц</div>
          <div class="mini" id="maxHint">Текущий месяц — предустановленные значения. Менять удобно со следующего месяца (просто выберите его сверху).</div>
        </div>
        <div class="rowBetween" style="gap:8px">
          <button class="btn mini" id="btnApplyMax">Применить</button>
        </div>
      </div>

      <div class="formGrid" id="maxForm"></div>

      <div style="height:14px"></div>

      <div class="rowBetween">
        <div>
          <div class="title2">Экспорт / импорт</div>
          <div class="mini">Перенос данных между устройствами (копипаст JSON).</div>
        </div>
        <div class="rowBetween" style="gap:8px">
          <button class="btn mini" id="btnExport">Экспорт</button>
          <button class="btn mini" id="btnImport">Импорт</button>
          <button class="btn mini bad" id="btnResetAll">Сброс всё</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <textarea id="io" placeholder="Тут появится JSON (экспорт) / сюда вставьте JSON (импорт)"></textarea>

      <div style="height:12px"></div>
      <div class="title2">Как это устроено</div>
      <div class="mini">
        Прогресс хранится в <b>localStorage</b> (устройства) и разделён по <b>месяцам</b>.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   0) УТИЛИТЫ
========================= */
const STORE_KEY = "training_pwa_v2"; // сохраняем совместимость с вашим текущим хранилищем

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function currentMonthKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function roundTo(x, inc){
  return Math.round(x / inc) * inc;
}
function fmtWeight(w){
  if (Number.isInteger(w)) return String(w);
  return String(w).replace(/\.0$/, "");
}
function epley1RM(w, reps){
  return w * (1 + reps/30);
}
function keyCheck(ex, sid, blockIdx, setIdx){
  return `${ex}|${sid}|${blockIdx}|${setIdx}`;
}
function keySession(ex, sid){
  return `${ex}|${sid}`;
}
function parseSid(sid){
  const [w, d] = String(sid).split(".");
  return { week: Number(w), day: Number(d) };
}
const RU_MONTHS = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
function monthLabel(key){
  const [y,m] = key.split("-");
  const mi = Number(m)-1;
  return `${RU_MONTHS[mi]} ${y}`;
}
function lastNMonths(n){
  const out = [];
  const d = new Date();
  d.setDate(1);
  for(let i=0;i<n;i++){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    out.push(`${y}-${m}`);
    d.setMonth(d.getMonth()-1);
  }
  return out;
}

/* =========================
   1) МАКСИМУМЫ (ДЕФОЛТЫ)
   Предустановленные значения для текущего месяца
========================= */
function defaultMaxes(){
  return {
    // Жим — 1ПМ
    bench1RM: 90,

    // Тренажёры рук: шаг 5 кг
    triceps: { maxW: 40, maxReps: 6, inc: 5 },
    biceps:  { maxW: 55, maxReps: 6, inc: 5 },

    // Тяга верхнего блока: шаг 5 кг (макс 1×65)
    pulldown:{ maxW: 65, maxReps: 1, inc: 5 },

    // Ноги
    legpress:{ maxW: 170, maxReps: 4, inc: 5 },
    legext:  { maxW: 55,  maxReps: 6, inc: 2.5 },
    legadd:  { maxW: 55,  maxReps: 6, inc: 2.5 }, // сведение ног

    // Плечи: жим на плечи (1ПМ 45)
    // (шаг по умолчанию 2.5 — если у вас шаг 5, можно поменять в коде за 1 строку)
    shoulder:{ maxW: 45,  maxReps: 1, inc: 2.5 },
  };
}

/* =========================
   2) ХРАНИЛИЩЕ + МИГРАЦИЯ
========================= */
function loadStore(){
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
  catch { return {}; }
}
function saveStore(s){
  localStorage.setItem(STORE_KEY, JSON.stringify(s));
}

let store = loadStore();
if (!store.schemaVersion) store.schemaVersion = 1;

// Миграция старого формата (checks/doneAt без months) -> months (v4)
if (store.schemaVersion < 4){
  const mk = store.activeMonth || currentMonthKey();
  const checks = store.checks || {};
  const doneAt = store.doneAt || {};

  store.months = store.months || {};
  store.months[mk] = store.months[mk] || { checks:{}, doneAt:{}, maxes: defaultMaxes() };
  store.months[mk].checks = checks;
  store.months[mk].doneAt = doneAt;

  store.activeMonth = mk;

  delete store.checks;
  delete store.doneAt;

  // вкладки по умолчанию
  if (!store.activeGroup) store.activeGroup = "Грудь";
  if (!store.activeExercise) store.activeExercise = "Жим лёжа";

  store.schemaVersion = 4;
  saveStore(store);
}

// Миграция названия: "Сгибания ног" -> "Сведение ног" (v5)
if (store.schemaVersion < 5){
  const OLD = "Сгибания ног";
  const NEW = "Сведение ног";

  if (store.months){
    for (const mk of Object.keys(store.months)){
      const mo = store.months[mk];
      if (!mo || !mo.checks || !mo.doneAt) continue;

      const newChecks = {};
      for (const k of Object.keys(mo.checks)){
        if (k.startsWith(OLD + "|")) newChecks[NEW + "|" + k.slice((OLD+"|").length)] = mo.checks[k];
        else newChecks[k] = mo.checks[k];
      }
      mo.checks = newChecks;

      const newDone = {};
      for (const k of Object.keys(mo.doneAt)){
        if (k.startsWith(OLD + "|")) newDone[NEW + "|" + k.slice((OLD+"|").length)] = mo.doneAt[k];
        else newDone[k] = mo.doneAt[k];
      }
      mo.doneAt = newDone;
    }
  }

  if (store.activeExercise === OLD) store.activeExercise = NEW;

  store.schemaVersion = 5;
  saveStore(store);
}

// гарантируем структуру
if (!store.months) store.months = {};
if (!store.activeMonth) store.activeMonth = currentMonthKey();
if (!store.months[store.activeMonth]) store.months[store.activeMonth] = { checks:{}, doneAt:{}, maxes: defaultMaxes() };
if (!store.months[store.activeMonth].maxes) store.months[store.activeMonth].maxes = defaultMaxes();

function monthObj(){
  if (!store.months[store.activeMonth]){
    // новый месяц: копируем maxes из ближайшего прошлого, иначе дефолт
    const keys = Object.keys(store.months).sort().reverse();
    const prev = keys.find(k => k < store.activeMonth);
    const base = prev ? store.months[prev].maxes : defaultMaxes();
    store.months[store.activeMonth] = { checks:{}, doneAt:{}, maxes: JSON.parse(JSON.stringify(base)) };
  }
  const mo = store.months[store.activeMonth];
  if (!mo.checks) mo.checks = {};
  if (!mo.doneAt) mo.doneAt = {};
  if (!mo.maxes) mo.maxes = defaultMaxes();
  return mo;
}

/* =========================
   3) ПЛАНЫ (динамические по maxes месяца)
   Важное: дни недели НЕ используются.
   День 1/2/3 — это порядок внутри недели:
     День 1: Жим + Трицепс + Бицепс + Тяга верхнего блока
     День 2: Жим + Ноги
     День 3: Жим + Трицепс + Бицепс + Плечи
========================= */

// База жима: ваш исходный план при 1ПМ=90 (TM=81). Далее масштабируем по 1ПМ месяца.
const BASE_BENCH_1RM = 90;
const BASE_BENCH_TM = BASE_BENCH_1RM * 0.90;

const BENCH_BASE = [
  { id:"1.1", sets:[ {w:60, r:3, n:1}, {w:70, r:2, n:2}, {w:77.5, r:1, n:2} ] },
  { id:"1.2", sets:[ {w:60, r:3, n:1}, {w:70, r:3, n:5} ] },
  { id:"1.3", sets:[ {w:60, r:3, n:1}, {w:75, r:3, n:4} ] },

  { id:"2.1", sets:[ {w:55, r:4, n:1}, {w:67.5, r:3, n:3}, {w:77.5, r:2, n:3} ] },
  { id:"2.2", sets:[ {w:67.5, r:3, n:3}, {w:77.5, r:2, n:3} ] },
  { id:"2.3", sets:[ {w:67.5, r:3, n:1}, {w:77.5, r:2, n:2}, {w:87.5, r:1, n:2} ] },

  { id:"3.1", sets:[ {w:52.5, r:5, n:1}, {w:62.5, r:4, n:4} ] },
  { id:"3.2", sets:[ {w:62.5, r:5, n:3} ] },
  { id:"3.3", sets:[ {w:62.5, r:5, n:1}, {w:72.5, r:5, n:5} ] },

  { id:"4.1", sets:[ {w:52.5, r:5, n:5} ] },
  { id:"4.2", sets:[ {w:70, r:4, n:4} ] },
  { id:"4.3", sets:[ {w:70, r:4, n:3}, {w:80, r:3, n:3} ] },
];

function buildBenchPlan(oneRM){
  const TM = oneRM * 0.90;
  const sessions = BENCH_BASE.map(s=>{
    return {
      id: s.id,
      sets: s.sets.map(blk=>{
        const pct = blk.w / BASE_BENCH_TM;
        const w = roundTo(TM * pct, 2.5);
        return { w, r: blk.r, n: blk.n };
      })
    };
  });
  return { sessions, meta: { oneRM, TM, maxW: oneRM, maxReps: 1, inc: 2.5 } };
}

function makePlanFromTemplates({maxW, maxReps, inc, templates}){
  const oneRM = (maxReps === 1) ? maxW : epley1RM(maxW, maxReps);
  const TM = oneRM * 0.90;

  const sessions = Object.keys(templates).sort((a,b)=>{
    const pa = parseSid(a), pb = parseSid(b);
    return pa.week !== pb.week ? pa.week - pb.week : pa.day - pb.day;
  }).map(sid=>{
    const blocks = templates[sid].map(([pct, reps, n])=>{
      let w = roundTo(TM * pct, inc);
      if (w < inc) w = inc;
      return { w, r: reps, n };
    });
    return { id: sid, sets: blocks };
  });

  return { sessions, meta: { oneRM, TM, maxW, maxReps, inc } };
}

function buildPlansForMonth(mk){
  const mo = store.months[mk] || { maxes: defaultMaxes() };
  const mx = mo.maxes || defaultMaxes();

  // Жим: 3/нед (1.1 / 1.2 / 1.3 и т.д.)
  const bench = buildBenchPlan(Number(mx.bench1RM || 90));

  // Руки: 2/нед — День 1 и День 3 (1.1, 1.3, 2.1, 2.3, ...)
  // Важно: избегаем "тяжёлых" процентов, чтобы не конфликтовать с тяжёлым жимом.
  const armsTemplates = {
    // Week 1
    "1.1":[ [0.50,12,1],[0.70,10,3],[0.75, 8,2] ],
    "1.3":[ [0.45,15,1],[0.60,12,3],[0.65,10,2] ],
    // Week 2 (немного плотнее на День 1, День 3 легче)
    "2.1":[ [0.50,12,1],[0.72,10,3],[0.78, 6,3] ],
    "2.3":[ [0.45,15,1],[0.62,12,3] ],
    // Week 3 (разгрузка/объём)
    "3.1":[ [0.45,15,1],[0.60,12,3] ],
    "3.3":[ [0.40,20,1],[0.55,15,3] ],
    // Week 4 (умеренно)
    "4.1":[ [0.50,12,1],[0.70,10,3],[0.76, 8,2] ],
    "4.3":[ [0.45,15,1],[0.62,12,3],[0.68,10,2] ],
  };

  const triceps = makePlanFromTemplates({ ...mx.triceps, templates: armsTemplates });
  const biceps  = makePlanFromTemplates({ ...mx.biceps,  templates: armsTemplates });

  // Тяга верхнего блока: 1/нед — только День 1 (1.1, 2.1, 3.1, 4.1)
  const pulldownTemplates = {
    "1.1":[ [0.50,12,1],[0.70,10,4] ],
    "2.1":[ [0.50,12,1],[0.75, 8,4] ],
    "3.1":[ [0.45,15,1],[0.65,10,3] ],
    "4.1":[ [0.50,12,1],[0.78, 8,4] ],
  };
  const pulldown = makePlanFromTemplates({ ...mx.pulldown, templates: pulldownTemplates });

  // Ноги: 1/нед — только День 2 (1.2, 2.2, 3.2, 4.2)
  // Правило: не делаем "тяжело" одновременно жим ногами + изоляцию
  const legPressTemplates = {
    "1.2":[ [0.40,15,1],[0.65,12,4],[0.72, 8,2] ],
    "2.2":[ [0.40,12,1],[0.72,10,4],[0.80, 6,2] ], // тяжелее
    "3.2":[ [0.35,20,1],[0.60,15,4] ],
    "4.2":[ [0.40,12,1],[0.75, 8,4],[0.82, 6,1] ], // тяжелее
  };
  const legIsoTemplates = {
    "1.2":[ [0.40,20,1],[0.65,12,4] ],
    "2.2":[ [0.40,20,1],[0.60,15,4] ], // легче (в паре с тяжелее leg press)
    "3.2":[ [0.35,25,1],[0.62,15,3] ],
    "4.2":[ [0.40,20,1],[0.60,15,3] ], // легче (в паре с тяжелее leg press)
  };

  const legpress = makePlanFromTemplates({ ...mx.legpress, templates: legPressTemplates });
  const legext   = makePlanFromTemplates({ ...mx.legext,   templates: legIsoTemplates });
  const legadd   = makePlanFromTemplates({ ...mx.legadd,   templates: legIsoTemplates });

  // Плечи: 1/нед — только День 3 (1.3,2.3,3.3,4.3), умеренно (без "убийства" жима)
  const shoulderTemplates = {
    "1.3":[ [0.50, 8,1],[0.65, 6,3],[0.70,5,2] ],
    "2.3":[ [0.50, 8,1],[0.67, 6,3],[0.72,5,2] ],
    "3.3":[ [0.45,10,1],[0.60, 8,3] ],
    "4.3":[ [0.50, 8,1],[0.65, 6,3],[0.70,5,2] ],
  };
  const shoulder = makePlanFromTemplates({ ...mx.shoulder, templates: shoulderTemplates });

  return {
    "Грудь": {
      "Жим лёжа": bench
    },
    "Руки": {
      "Трицепс": triceps,
      "Бицепс (блок)": biceps
    },
    "Спина": {
      "Тяга верхнего блока": pulldown
    },
    "Ноги": {
      "Жим ногами": legpress,
      "Разгибания ног": legext,
      "Сведение ног": legadd
    },
    "Плечи": {
      "Жим на плечи": shoulder
    }
  };
}

function plans(){
  return buildPlansForMonth(store.activeMonth);
}

/* =========================
   4) UI: месяц + максимумы
========================= */
const $monthSel = document.getElementById("monthSel");
const $maxForm = document.getElementById("maxForm");
const $maxHint = document.getElementById("maxHint");

function ensureActiveMonthExists(){
  if (!store.months[store.activeMonth]){
    const keys = Object.keys(store.months).sort().reverse();
    const prev = keys.find(k => k < store.activeMonth);
    const base = prev ? store.months[prev].maxes : defaultMaxes();
    store.months[store.activeMonth] = { checks:{}, doneAt:{}, maxes: JSON.parse(JSON.stringify(base)) };
    saveStore(store);
  }
}

function renderMonthSelect(){
  const options = lastNMonths(18);
  $monthSel.innerHTML = "";
  options.forEach(mk=>{
    const opt = document.createElement("option");
    opt.value = mk;
    opt.textContent = monthLabel(mk);
    if (mk === store.activeMonth) opt.selected = true;
    $monthSel.appendChild(opt);
  });

  const isCurrent = store.activeMonth === currentMonthKey();
  $maxHint.textContent = isCurrent
    ? "Текущий месяц — предустановленные значения (заполнитель). Менять удобно со следующего месяца: выберите следующий месяц сверху, выставьте новые 1ПМ/максы и нажмите «Применить»."
    : "Значения для выбранного месяца. Поменяли — нажмите «Применить», план пересчитается.";
}

function renderMaxForm(){
  const mo = monthObj();
  const mx = mo.maxes || defaultMaxes();
  $maxForm.innerHTML = "";

  function fieldNumber({id,label,value,step=1,min=0,max=1000,hint=""}){
    const wrap = document.createElement("div");
    wrap.className = "field";
    wrap.innerHTML = `
      <div class="label">${label}</div>
      <input class="inp" id="${id}" type="number" step="${step}" min="${min}" max="${max}" value="${value}">
      ${hint ? `<div class="hint">${hint}</div>` : ``}
    `;
    $maxForm.appendChild(wrap);
  }

  // Жим 1ПМ
  fieldNumber({
    id:"mx_bench",
    label:"Жим лёжа — 1ПМ (кг)",
    value: mx.bench1RM ?? 90,
    step: 2.5,
    min: 20,
    max: 300,
    hint:"1ПМ месяца -> TM=90% -> веса жима пересчитываются."
  });

  function pair(prefix, title, obj, stepW){
    fieldNumber({
      id:`${prefix}_w`,
      label:`${title} — макс вес (кг)`,
      value: obj.maxW,
      step: stepW,
      min: 0,
      max: 500,
      hint:`Шаг веса в плане: ${stepW} кг`
    });
    fieldNumber({
      id:`${prefix}_r`,
      label:`${title} — макс повторы`,
      value: obj.maxReps,
      step: 1,
      min: 1,
      max: 30,
      hint:`Оценка 1ПМ по Epley (если повторы > 1).`
    });
  }

  pair("mx_tri", "Трицепс (тренажёр)", mx.triceps, 5);
  pair("mx_bi",  "Бицепс (блок)",      mx.biceps,  5);
  pair("mx_pd",  "Тяга верхнего блока",mx.pulldown,5);

  pair("mx_lp",  "Жим ногами",         mx.legpress,5);
  pair("mx_le",  "Разгибания ног",     mx.legext,  2.5);
  pair("mx_la",  "Сведение ног",       mx.legadd,  2.5);

  pair("mx_sh",  "Жим на плечи",       mx.shoulder,2.5);
}

function applyMaxFromForm(){
  const mo = monthObj();
  const mx = mo.maxes || defaultMaxes();

  function num(id, fallback){
    const el = document.getElementById(id);
    const v = el ? Number(el.value) : NaN;
    return Number.isFinite(v) ? v : fallback;
  }

  mx.bench1RM = num("mx_bench", mx.bench1RM);

  mx.triceps = { maxW: num("mx_tri_w", mx.triceps.maxW), maxReps: num("mx_tri_r", mx.triceps.maxReps), inc: 5 };
  mx.biceps  = { maxW: num("mx_bi_w",  mx.biceps.maxW),  maxReps: num("mx_bi_r",  mx.biceps.maxReps),  inc: 5 };
  mx.pulldown= { maxW: num("mx_pd_w",  mx.pulldown.maxW),maxReps: num("mx_pd_r",  mx.pulldown.maxReps),inc: 5 };

  mx.legpress= { maxW: num("mx_lp_w", mx.legpress.maxW), maxReps: num("mx_lp_r", mx.legpress.maxReps), inc: 5 };
  mx.legext  = { maxW: num("mx_le_w", mx.legext.maxW),   maxReps: num("mx_le_r", mx.legext.maxReps),   inc: 2.5 };
  mx.legadd  = { maxW: num("mx_la_w", mx.legadd.maxW),   maxReps: num("mx_la_r", mx.legadd.maxReps),   inc: 2.5 };

  mx.shoulder= { maxW: num("mx_sh_w", mx.shoulder.maxW), maxReps: num("mx_sh_r", mx.shoulder.maxReps), inc: 2.5 };

  mo.maxes = mx;
  saveStore(store);
}

/* =========================
   5) РЕНДЕР (по упражнению)
========================= */
const $groupSeg = document.getElementById("groupSeg");
const $exerciseSeg = document.getElementById("exerciseSeg");
const $weeks = document.getElementById("weeks");
const $exTitle = document.getElementById("exTitle");
const $exMeta = document.getElementById("exMeta");
const $exProgress = document.getElementById("exProgress");
const $io = document.getElementById("io");

function findDefault(pl){
  const g = Object.keys(pl)[0];
  const e = Object.keys(pl[g])[0];
  return { g, e };
}

function validateActiveTabs(pl){
  if (!store.activeGroup || !pl[store.activeGroup]){
    const def = findDefault(pl);
    store.activeGroup = def.g;
  }
  if (!store.activeExercise || !pl[store.activeGroup][store.activeExercise]){
    store.activeExercise = Object.keys(pl[store.activeGroup])[0];
  }
  saveStore(store);
}

function sessionStats(mo, exName, sess){
  let sets = 0, reps = 0, tonnage = 0;
  sess.sets.forEach((blk)=>{
    sets += blk.n;
    reps += blk.n * blk.r;
    tonnage += blk.n * blk.r * blk.w;
  });

  let doneSets = 0;
  sess.sets.forEach((blk, bIdx)=>{
    for (let i=0;i<blk.n;i++){
      if (mo.checks[keyCheck(exName, sess.id, bIdx, i)]) doneSets++;
    }
  });

  return { sets, reps, tonnage, doneSets };
}

function isSessionDone(mo, exName, sess){
  const st = sessionStats(mo, exName, sess);
  return st.sets > 0 && st.doneSets === st.sets;
}
function markSessionDoneDate(mo, exName, sess){
  const k = keySession(exName, sess.id);
  if (isSessionDone(mo, exName, sess)){
    mo.doneAt[k] = mo.doneAt[k] || todayISO();
  } else {
    delete mo.doneAt[k];
  }
}

function renderGroupSeg(pl){
  $groupSeg.innerHTML = "";
  Object.keys(pl).forEach(g=>{
    const b = document.createElement("button");
    b.textContent = g;
    b.className = (g===store.activeGroup) ? "active" : "";
    b.onclick = ()=>{
      store.activeGroup = g;
      store.activeExercise = Object.keys(pl[g])[0];
      saveStore(store);
      renderAll();
    };
    $groupSeg.appendChild(b);
  });
}

function renderExerciseSeg(pl){
  $exerciseSeg.innerHTML = "";
  Object.keys(pl[store.activeGroup]).forEach(ex=>{
    const b = document.createElement("button");
    b.textContent = ex;
    b.className = (ex===store.activeExercise) ? "active" : "";
    b.onclick = ()=>{
      store.activeExercise = ex;
      saveStore(store);
      renderAll();
    };
    $exerciseSeg.appendChild(b);
  });
}

function renderWeeks(pl){
  $weeks.innerHTML = "";
  const mo = monthObj();

  const exGroup = store.activeGroup;
  const exName = store.activeExercise;
  const ex = pl[exGroup][exName];
  const meta = ex.meta;

  $exTitle.textContent = exName;

  // мета-текст + пометка "предустановлено" для текущего месяца
  const isCurrent = store.activeMonth === currentMonthKey();
  const presetTag = isCurrent ? " • предустановлено" : "";

  let metaText = "";
  if (exName === "Жим лёжа"){
    metaText = `Месяц: ${monthLabel(store.activeMonth)}${presetTag} • 1ПМ: ${fmtWeight(meta.oneRM)} кг • TM≈${fmtWeight(meta.TM)} кг • 4 недели × 3 тренировки`;
  } else {
    metaText = `Месяц: ${monthLabel(store.activeMonth)}${presetTag} • Макс: ${fmtWeight(meta.maxW)}×${meta.maxReps} • 1ПМ≈${fmtWeight(meta.oneRM)} • TM≈${fmtWeight(meta.TM)}`;
  }
  $exMeta.textContent = metaText;

  // прогресс
  let total = 0, done = 0;
  ex.sessions.forEach(s=>{
    const st = sessionStats(mo, exName, s);
    total += st.sets;
    done += st.doneSets;
  });
  $exProgress.textContent = `Прогресс: ${done}/${total} подходов`;

  // группировка по неделям
  const byWeek = new Map();
  ex.sessions.forEach(s=>{
    const w = parseSid(s.id).week || 0;
    if (!byWeek.has(w)) byWeek.set(w, []);
    byWeek.get(w).push(s);
  });

  [...byWeek.keys()].sort((a,b)=>a-b).forEach(weekNo=>{
    const sessions = byWeek.get(weekNo).sort((a,b)=>parseSid(a.id).day-parseSid(b.id).day);

    let wTotal=0, wDone=0;
    sessions.forEach(s=>{
      const st = sessionStats(mo, exName, s);
      wTotal += st.sets;
      wDone += st.doneSets;
    });

    const det = document.createElement("details");
    det.className = "week";
    det.open = true;

    const sum = document.createElement("summary");
    sum.innerHTML = `<div>Неделя ${weekNo}</div><div class="weekMeta">${wDone}/${wTotal} подходов</div>`;
    det.appendChild(sum);

    sessions.forEach(sess=>{
      const st = sessionStats(mo, exName, sess);
      const doneSess = isSessionDone(mo, exName, sess);
      const doneDate = mo.doneAt[keySession(exName, sess.id)];
      const dayNo = parseSid(sess.id).day;

      const wrap = document.createElement("div");
      wrap.className = "session";
      wrap.dataset.sid = sess.id;

      const head = document.createElement("div");
      head.className = "sessionHead";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="sid">День ${dayNo} <span class="muted2">(${sess.id})</span></div>
        <div class="stats">${st.doneSets}/${st.sets} подходов • ${st.reps} повторов • тоннаж ${fmtWeight(st.tonnage)} кг</div>
      `;

      const right = document.createElement("div");
      right.className = "sessionBtns";

      const badge = document.createElement("div");
      badge.className = "badge" + (doneSess ? " done" : "");
      badge.textContent = doneSess ? `Выполнено${doneDate ? " • "+doneDate : ""}` : "Не выполнено";

      const btnAll = document.createElement("button");
      btnAll.className = "btn mini ok";
      btnAll.textContent = "✓ всё";
      btnAll.onclick = ()=>{
        sess.sets.forEach((blk,bIdx)=>{
          for(let i=0;i<blk.n;i++) mo.checks[keyCheck(exName, sess.id, bIdx, i)] = true;
        });
        markSessionDoneDate(mo, exName, sess);
        saveStore(store);
        renderAll();
      };

      const btnClear = document.createElement("button");
      btnClear.className = "btn mini bad";
      btnClear.textContent = "Сброс";
      btnClear.onclick = ()=>{
        sess.sets.forEach((blk,bIdx)=>{
          for(let i=0;i<blk.n;i++) delete mo.checks[keyCheck(exName, sess.id, bIdx, i)];
        });
        delete mo.doneAt[keySession(exName, sess.id)];
        saveStore(store);
        renderAll();
      };

      right.appendChild(badge);
      right.appendChild(btnAll);
      right.appendChild(btnClear);

      head.appendChild(left);
      head.appendChild(right);

      const sets = document.createElement("div");
      sets.className = "sets";

      sess.sets.forEach((blk, bIdx)=>{
        const row = document.createElement("div");
        row.className = "setRow";

        const l = document.createElement("div");
        l.className = "setLeft";
        l.innerHTML = `
          <div class="mainLine">${fmtWeight(blk.w)} × ${blk.r}</div>
          <div class="minorLine">${blk.n} подход(а/ов) • всего ${blk.n*blk.r} повторов</div>
        `;

        const r = document.createElement("div");
        r.className = "checks";

        for (let i=0;i<blk.n;i++){
          const c = document.createElement("div");
          const ck = keyCheck(exName, sess.id, bIdx, i);
          c.className = "chk" + (mo.checks[ck] ? " on" : "");
          c.textContent = mo.checks[ck] ? "✓" : (i+1);
          c.onclick = ()=>{
            mo.checks[ck] = !mo.checks[ck];
            markSessionDoneDate(mo, exName, sess);
            saveStore(store);
            renderAll();
          };
          r.appendChild(c);
        }

        const quick = document.createElement("button");
        quick.className = "btn mini ok";
        quick.textContent = "✓ все";
        quick.onclick = ()=>{
          let allOn = true;
          for (let i=0;i<blk.n;i++){
            if (!mo.checks[keyCheck(exName, sess.id, bIdx, i)]) { allOn=false; break; }
          }
          for (let i=0;i<blk.n;i++){
            const ck = keyCheck(exName, sess.id, bIdx, i);
            if (allOn) delete mo.checks[ck];
            else mo.checks[ck] = true;
          }
          markSessionDoneDate(mo, exName, sess);
          saveStore(store);
          renderAll();
        };
        r.appendChild(quick);

        row.appendChild(l);
        row.appendChild(r);
        sets.appendChild(row);
      });

      wrap.appendChild(head);
      wrap.appendChild(sets);
      det.appendChild(wrap);
    });

    $weeks.appendChild(det);
  });
}

/* =========================
   6) КНОПКИ + I/O
========================= */
function nextIncomplete(pl){
  const mo = monthObj();
  const exName = store.activeExercise;
  const ex = pl[store.activeGroup][exName];
  for (const s of ex.sessions){
    if (!isSessionDone(mo, exName, s)) return s.id;
  }
  return null;
}
function scrollToSession(sid){
  const el = document.querySelector(`.session[data-sid="${sid}"]`);
  if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

function renderAll(){
  ensureActiveMonthExists();
  const pl = plans();
  validateActiveTabs(pl);

  renderMonthSelect();
  renderMaxForm();

  renderGroupSeg(pl);
  renderExerciseSeg(pl);
  renderWeeks(pl);
}

$monthSel.onchange = ()=>{
  store.activeMonth = $monthSel.value;
  ensureActiveMonthExists();
  saveStore(store);
  renderAll();
};

document.getElementById("btnApplyMax").onclick = ()=>{
  applyMaxFromForm();
  renderAll();
};

document.getElementById("btnNext").onclick = ()=>{
  const pl = plans();
  const sid = nextIncomplete(pl);
  if (!sid) return alert("В этом упражнении всё отмечено как выполненное (в выбранном месяце).");
  scrollToSession(sid);
};

document.getElementById("btnResetExercise").onclick = ()=>{
  const mo = monthObj();
  const exName = store.activeExercise;
  if (!confirm(`Сбросить отметки для упражнения "${exName}" за ${monthLabel(store.activeMonth)}?`)) return;

  Object.keys(mo.checks).forEach(k=>{
    if (k.startsWith(exName + "|")) delete mo.checks[k];
  });
  Object.keys(mo.doneAt).forEach(k=>{
    if (k.startsWith(exName + "|")) delete mo.doneAt[k];
  });

  saveStore(store);
  renderAll();
};

document.getElementById("btnResetAll").onclick = ()=>{
  if (!confirm("Сбросить ВСЕ отметки по всем месяцам и упражнениям?")) return;
  store.months = {};
  store.activeMonth = currentMonthKey();
  store.months[store.activeMonth] = { checks:{}, doneAt:{}, maxes: defaultMaxes() };
  saveStore(store);
  renderAll();
};

document.getElementById("btnExport").onclick = ()=>{
  $io.value = JSON.stringify(store, null, 2);
};

document.getElementById("btnImport").onclick = ()=>{
  try{
    const incoming = JSON.parse($io.value || "{}");
    if (!incoming || typeof incoming !== "object") throw new Error("bad");

    if (!incoming.schemaVersion) incoming.schemaVersion = 5;
    if (!incoming.months) incoming.months = {};
    if (!incoming.activeMonth) incoming.activeMonth = currentMonthKey();
    if (!incoming.months[incoming.activeMonth]) incoming.months[incoming.activeMonth] = { checks:{}, doneAt:{}, maxes: defaultMaxes() };
    if (!incoming.months[incoming.activeMonth].maxes) incoming.months[incoming.activeMonth].maxes = defaultMaxes();

    store = incoming;
    saveStore(store);
    renderAll();
    alert("Импорт выполнен.");
  }catch(e){
    alert("Не удалось импортировать JSON. Проверьте содержимое поля.");
  }
};

/* =========================
   7) PWA: service worker
========================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js?v=7").catch(()=>{});
  });
}

renderAll();
</script>
</body>
</html>
