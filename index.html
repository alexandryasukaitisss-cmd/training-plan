<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0c" />
  <title>Тренировки</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg: #0b0b0c;
      --card: #151517;
      --card2:#1c1c1f;
      --txt: #f3f3f4;
      --muted:#a7a7ad;
      --line:#2b2b31;
      --ok:#34c759;
      --warn:#ff9f0a;
      --tap: 52px;
      --r: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f2f2f7; --card:#ffffff; --card2:#f6f6fb; --txt:#111114;
        --muted:#5a5a63; --line:#e3e3ea;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--txt);
    }
    .wrap{max-width:920px; margin:0 auto; padding:16px 14px 28px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:6px 2px 14px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    h1{margin:0; font-size:20px; font-weight:700; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .actions{display:flex; gap:10px; align-items:center}
    button{
      height:40px; padding:0 12px; border-radius:12px; border:1px solid var(--line);
      background:var(--card); color:var(--txt); font-weight:600; cursor:pointer;
    }
    button:active{transform:translateY(1px)}
    .tabs{
      display:flex; gap:10px; overflow:auto; padding:6px 2px 14px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      height:40px; padding:0 14px; border-radius:999px; border:1px solid var(--line);
      background:transparent; color:var(--txt); font-weight:700; white-space:nowrap;
    }
    .tab.active{background:var(--card);}

    .grid{display:grid; grid-template-columns: 1fr; gap:12px}
    @media (min-width:860px){
      .grid{grid-template-columns: 1.2fr .8fr}
    }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}
    .hint{color:var(--muted); font-size:13px; margin-top:6px; line-height:1.35}

    .session{
      background:var(--card2); border:1px solid var(--line); border-radius:14px;
      padding:12px; margin-bottom:10px;
    }
    .sessionHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sid{font-weight:800}
    .badge{
      font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted);
    }
    .badge.done{border-color: rgba(52,199,89,.35); color: var(--ok);}
    .sets{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .setRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px; border-radius:12px; border:1px solid var(--line);
      background:var(--card);
      min-height: var(--tap);
    }
    .setLeft{display:flex; flex-direction:column; gap:2px}
    .mainLine{font-weight:800}
    .minorLine{font-size:12px; color:var(--muted)}
    .checks{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chk{
      width:36px; height:36px; border-radius:10px;
      border:1px solid var(--line); display:grid; place-items:center;
      cursor:pointer; user-select:none; font-weight:900;
      background:transparent;
    }
    .chk.on{border-color: rgba(52,199,89,.45); background: rgba(52,199,89,.12); color: var(--ok);}
    .row2{display:flex; gap:10px; flex-wrap:wrap}
    .row2 button{height:42px}
    .danger{border-color: rgba(255,59,48,.35); color: #ff3b30;}
    .ok{border-color: rgba(52,199,89,.35);}

    textarea{
      width:100%; min-height:130px; resize:vertical;
      background:var(--card2); color:var(--txt);
      border:1px solid var(--line); border-radius:14px;
      padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
    }
    .mini{font-size:12px; color:var(--muted)}
    a{color:inherit}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Тренировочный план</h1>
      <div class="sub" id="subtitle">Открывается как приложение, отметки сохраняются на устройстве</div>
    </div>
    <div class="actions">
      <button id="btnNext" class="ok" title="Открыть следующую не выполненную">Следующая</button>
      <button id="btnReset" class="danger" title="Сбросить отметки текущего упражнения">Сброс</button>
    </div>
  </header>

  <div class="tabs" id="tabs"></div>

  <div class="grid">
    <div class="card">
      <h2 id="exTitle">—</h2>
      <div id="sessions"></div>
      <div class="hint">
        Логика отметок: каждый “квадратик” = один подход. Отмечаешь — прогресс сохраняется в памяти браузера (localStorage).
      </div>
    </div>

    <div class="card">
      <h2>Данные и перенос</h2>
      <div class="row2" style="margin-bottom:10px">
        <button id="btnExport">Экспорт</button>
        <button id="btnImport">Импорт</button>
        <button id="btnResetAll" class="danger">Сброс ВСЁ</button>
      </div>
      <div class="mini">Экспорт/импорт полезны, если хочешь перенести отметки на другое устройство (вручную через копипаст).</div>
      <div style="height:10px"></div>
      <textarea id="io" placeholder="Тут появится JSON для экспорта / сюда можно вставить JSON для импорта"></textarea>
      <div class="hint">
        Чтобы добавить новые упражнения/вкладки: в коде ниже есть объект <b>PLANS</b>. Копируешь структуру “Жим лёжа”, меняешь названия/подходы.
      </div>
    </div>
  </div>
</div>

<script>
  // ====== 1) ПЛАНЫ (редактируй здесь) ======
  // формат: { "Упражнение": [ {id:"1.1", sets:[{w:60, r:3, n:1}, ...]} ] }
  const PLANS = {
    "Жим лёжа": [
      { id:"1.1", sets:[ {w:60, r:3, n:1}, {w:70, r:2, n:2}, {w:77.5, r:1, n:2} ] },
      { id:"1.2", sets:[ {w:60, r:3, n:1}, {w:70, r:3, n:5} ] },
      { id:"1.3", sets:[ {w:60, r:3, n:1}, {w:75, r:3, n:4} ] },

      { id:"2.1", sets:[ {w:55, r:4, n:1}, {w:67.5, r:3, n:3}, {w:77.5, r:2, n:3} ] },
      { id:"2.2", sets:[ {w:67.5, r:3, n:3}, {w:77.5, r:2, n:3} ] },
      { id:"2.3", sets:[ {w:67.5, r:3, n:1}, {w:77.5, r:2, n:2}, {w:87.5, r:1, n:2} ] },

      { id:"3.1", sets:[ {w:52.5, r:5, n:1}, {w:62.5, r:4, n:4} ] },
      { id:"3.2", sets:[ {w:62.5, r:5, n:3} ] },
      { id:"3.3", sets:[ {w:62.5, r:5, n:1}, {w:72.5, r:5, n:5} ] },

      { id:"4.1", sets:[ {w:52.5, r:5, n:5} ] },
      { id:"4.2", sets:[ {w:70, r:4, n:4} ] },
      { id:"4.3", sets:[ {w:70, r:4, n:3}, {w:80, r:3, n:3} ] },
    ],

    // Пример вкладки под другое упражнение — можешь заполнить позже
    "Присед": [
      { id:"—", sets:[ {w:0, r:0, n:0} ] }
    ],
    "Тяга": [
      { id:"—", sets:[ {w:0, r:0, n:0} ] }
    ]
  };

  // ====== 2) ХРАНИЛИЩЕ ======
  const STORE_KEY = "training_pwa_v1";
  function loadStore(){
    try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

  // структура: store = { activeExercise:"Жим лёжа", checks:{ "Жим лёжа|1.1|0|0": true, ... }, doneAt:{ "Жим лёжа|1.1": "2025-12-14" } }
  let store = loadStore();
  if (!store.checks) store.checks = {};
  if (!store.doneAt) store.doneAt = {};
  if (!store.activeExercise || !PLANS[store.activeExercise]) store.activeExercise = Object.keys(PLANS)[0];

  // ====== 3) UI ======
  const $tabs = document.getElementById("tabs");
  const $sessions = document.getElementById("sessions");
  const $exTitle = document.getElementById("exTitle");
  const $io = document.getElementById("io");

  function keyCheck(ex, sid, setIdx, repIdx){
    return `${ex}|${sid}|${setIdx}|${repIdx}`;
  }
  function keySession(ex, sid){
    return `${ex}|${sid}`;
  }
  function fmtWeight(w){
    if (Number.isInteger(w)) return String(w);
    return String(w).replace(/\.0$/, "");
  }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function renderTabs(){
    $tabs.innerHTML = "";
    Object.keys(PLANS).forEach(name=>{
      const b = document.createElement("button");
      b.className = "tab" + (name === store.activeExercise ? " active" : "");
      b.textContent = name;
      b.onclick = ()=>{
        store.activeExercise = name;
        saveStore(store);
        renderAll();
      };
      $tabs.appendChild(b);
    });
  }

  function sessionProgress(ex, sess){
    const sid = sess.id;
    let total = 0, done = 0;
    sess.sets.forEach((s, setIdx)=>{
      for(let i=0;i<s.n;i++){
        total++;
        if (store.checks[keyCheck(ex, sid, setIdx, i)]) done++;
      }
    });
    return { total, done };
  }

  function isSessionDone(ex, sess){
    const p = sessionProgress(ex, sess);
    return p.total > 0 && p.done === p.total;
  }

  function markSessionDoneIfComplete(ex, sess){
    const k = keySession(ex, sess.id);
    if (isSessionDone(ex, sess)) {
      store.doneAt[k] = store.doneAt[k] || todayISO();
    } else {
      delete store.doneAt[k];
    }
  }

  function renderSessions(){
    const ex = store.activeExercise;
    $exTitle.textContent = ex;
    $sessions.innerHTML = "";

    PLANS[ex].forEach((sess)=>{
      const p = sessionProgress(ex, sess);
      const done = isSessionDone(ex, sess);
      const doneDate = store.doneAt[keySession(ex, sess.id)];

      const wrap = document.createElement("div");
      wrap.className = "session";

      const head = document.createElement("div");
      head.className = "sessionHead";

      const left = document.createElement("div");
      left.innerHTML = `<div class="sid">${sess.id}</div>
                        <div class="mini">${p.done}/${p.total} подходов</div>`;

      const badge = document.createElement("div");
      badge.className = "badge" + (done ? " done" : "");
      badge.textContent = done ? `Выполнено${doneDate ? " • " + doneDate : ""}` : "Не выполнено";

      head.appendChild(left);
      head.appendChild(badge);

      const sets = document.createElement("div");
      sets.className = "sets";

      sess.sets.forEach((s, setIdx)=>{
        const row = document.createElement("div");
        row.className = "setRow";

        const l = document.createElement("div");
        l.className = "setLeft";
        l.innerHTML = `<div class="mainLine">${fmtWeight(s.w)} × ${s.r}</div>
                       <div class="minorLine">${s.n} подход(а/ов)</div>`;

        const r = document.createElement("div");
        r.className = "checks";

        for(let i=0;i<s.n;i++){
          const c = document.createElement("div");
          const ck = keyCheck(ex, sess.id, setIdx, i);
          c.className = "chk" + (store.checks[ck] ? " on" : "");
          c.textContent = store.checks[ck] ? "✓" : (i+1);
          c.onclick = ()=>{
            store.checks[ck] = !store.checks[ck];
            markSessionDoneIfComplete(ex, sess);
            saveStore(store);
            renderSessions(); // достаточно
          };
          r.appendChild(c);
        }

        row.appendChild(l);
        row.appendChild(r);
        sets.appendChild(row);
      });

      wrap.appendChild(head);
      wrap.appendChild(sets);
      $sessions.appendChild(wrap);
    });
  }

  function nextIncomplete(){
    const ex = store.activeExercise;
    const list = PLANS[ex];
    for (const sess of list){
      if (!isSessionDone(ex, sess)) return sess.id;
    }
    return null;
  }

  function scrollToSession(sid){
    const nodes = [...document.querySelectorAll(".session .sid")];
    const n = nodes.find(x => x.textContent.trim() === sid);
    if (n) n.closest(".session").scrollIntoView({behavior:"smooth", block:"start"});
  }

  function renderAll(){
    renderTabs();
    renderSessions();
  }

  // ====== 4) КНОПКИ ======
  document.getElementById("btnNext").onclick = ()=>{
    const sid = nextIncomplete();
    if (!sid) return alert("Все сессии в этой вкладке отмечены как выполненные.");
    scrollToSession(sid);
  };

  document.getElementById("btnReset").onclick = ()=>{
    const ex = store.activeExercise;
    if (!confirm(`Сбросить отметки для упражнения "${ex}"?`)) return;

    Object.keys(store.checks).forEach(k=>{
      if (k.startsWith(ex + "|")) delete store.checks[k];
    });
    Object.keys(store.doneAt).forEach(k=>{
      if (k.startsWith(ex + "|")) delete store.doneAt[k];
    });
    saveStore(store);
    renderAll();
  };

  document.getElementById("btnResetAll").onclick = ()=>{
    if (!confirm("Сбросить ВСЕ отметки и даты по всем упражнениям?")) return;
    store.checks = {};
    store.doneAt = {};
    saveStore(store);
    renderAll();
  };

  document.getElementById("btnExport").onclick = ()=>{
    $io.value = JSON.stringify(store, null, 2);
  };

  document.getElementById("btnImport").onclick = ()=>{
    try{
      const incoming = JSON.parse($io.value || "{}");
      if (!incoming || typeof incoming !== "object") throw new Error("bad");
      // минимальная валидация
      if (!incoming.checks) incoming.checks = {};
      if (!incoming.doneAt) incoming.doneAt = {};
      if (!incoming.activeExercise || !PLANS[incoming.activeExercise]) incoming.activeExercise = Object.keys(PLANS)[0];
      store = incoming;
      saveStore(store);
      renderAll();
      alert("Импорт выполнен.");
    }catch(e){
      alert("Не удалось импортировать JSON. Проверь содержимое поля.");
    }
  };

  // ====== 5) PWA: регистрация service worker ======
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  renderAll();
</script>
</body>
</html>
